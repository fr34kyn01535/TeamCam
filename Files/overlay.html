<html>
<head>
	<title>TeamCam</title>
	<link href="css/jquery-ui.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap-material-design.css" rel="stylesheet">
	<link href="css/ripples.min.css" rel="stylesheet">
	<link href="css/global.css" rel="stylesheet">
	<link href="css/overlay.css" rel="stylesheet">


	<script src="js/jquery.js"></script> 

	<script src="js/jquery-ui.min.js"></script> 
	<script src="js/material.min.js"></script> 
	<script src="js/ripples.min.js"></script> 
	
	<script src="js/strophejingle.bundle.js"></script> 
	<script src="js/overlay.js"></script> 

    <script type="text/javascript">
        var ts3 = {};
		var cam = new main();
		
		var activeServerId;
		var windowId;
		var settingsId;
		
		function reconnect(){
			cam.disconnect();
			
			
			$("#videos .video").fadeOut(200,function(){
				$("#videos .video").remove();
			});
			
			ts3.getServerInfo(activeServerId,function(success,channel){
				if(!success.success) return;
				var username = btoa(unescape(encodeURIComponent(channel.myClientName)));
				
				$("#username .value").text(channel.myClientName);
				$("#localVideo").attr("data_nickname",channel.myClientName);
				
				var room = btoa(unescape(encodeURIComponent(channel.channelName+channel.host)));
				
				$("#info").html("Host: "+channel.host+"<br/>Channel: "+channel.channelName);
				
				cam.connect(username,room);
			});
		}
	
        function ts3Loaded() {
			ts3 = $("#ts3")[0];

			setTimeout(function() {
				ts3.init({name:""}, function(result,servers) {
					if(result.error){
						critical("Teamspeak 3 could not be detected, restart Overwolf as Admin...");
						return;
					}
					activeServerId = servers.activeServerId;
					init();
					reconnect();
				});
			}, 500);
        }
		
	
		function critical(message){
			alert(message);
			close();
		}
		
		function init(){
            ts3.addEventListener("onServerStatusChange", function(data) {
				if(data.status == "CONNECTION_ESTABLISHED"){
					console.log("onServerStatusChang: ",data);
					activeServerId = data.serverId;
					reconnect();
				}
            });
			
			ts3.addEventListener("onActiveServerChanged",
			  function(serverId) {
					activeServerId = serverId;
					reconnect();
			  }
			);
			
			ts3.addEventListener("onDisconnectedFromClient",
			   function(){
				   close();
				}
			);
 
			ts3.addEventListener("onClientEvent",
			  function(e) {
					if(e.isOwnClient && e.newChannelId){
						reconnect();
					}
			  }
			);
			
			
			ts3.addEventListener("onTalkStatusChanged",
			  function(e) {
				if(e.state == "Talk"){
					var talkingVideo = $("video[data_nickname='"+e.clientName+"'");
					if(talkingVideo.length != 0){
						$("video").css("z-index",0);
						talkingVideo.css("z-index",999);
						talkingVideo.addClass("talking");
						$("#username .value").text(e.clientName);
						$("#username").addClass("talking");
					}
				}
				
				if(e.state == "StopTalk"){
					var talkingVideo = $("video[data_nickname='"+e.clientName+"'");
					if(talkingVideo.length != 0){
						$("#username").removeClass("talking");
						talkingVideo.removeClass("talking");
					}
				}
			  }
			);
		}
		
		$(function(){
			$.material.init();
			overwolf.windows.getCurrentWindow(function(result){
				if (result.status=="success"){
					windowId = result.window.id;
				}
			});
				 
			overwolf.windows.onStateChanged.addListener(
				function (result) {
					if(result.window_id == settingsId && result.window_state=="closed"){
						reconnect();
					}
				}
			);
			
			$("#username").hover(function(){
				$("#info").fadeIn(250);
			},function(){
				$("#info").fadeOut(250);
			});
			
			$("#settings").click(function(){
				overwolf.windows.obtainDeclaredWindow("settings",
						function(result){
							if (result.status == "success"){
								settingsId = result.window.id;
								overwolf.windows.restore(settingsId);
							}
						 }
				 );
			});
			
			overwolf.games.onGameInfoUpdated.addListener(
				function (value) {
					console.log(value);
				}
			);
		});
    </script>
	</head>
	<body>
	<div id="videos">
				<video style="z-index:1" id="localVideo"></video>
		</div>
	<div id="overlay">
		
		<div id="username">
		<span class="value"></span>
		<div id="settings"><i class="material-icons">settings</i></div>
		<div id="info" style="display:none;"></div>
		</div>
	</div>
		<object id="ts3" type="application/x-overwolfteamspeakplugin">
			<param name="onload" value="ts3Loaded" />
		</object>
		</body>
</html>
